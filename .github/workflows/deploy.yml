name: Deploy VuePress to GitHub Pages

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 必须添加，获取完整提交历史

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # 升级到更稳定的 LTS 版本
          cache: 'npm'

      - name: Install Dependencies
        run: |
          echo "📦 安装依赖..."
          npm ci  # 使用更可靠的依赖安装方式
          echo "✅ 安装完成"

      - name: Build
        run: |
          echo "🚀 开始构建网站..."
          
          # 修复的关键点：使用正确的构建命令
          npm run docs:build  # 必须是 docs:build（与package.json一致）
          
          echo "查看构建输出目录："
          ls -la ./docs/.vuepress/dist || echo "❌ 构建失败，没有生成 dist 文件夹！"
          
          # 添加文件检查
          echo "检查首页文件是否存在："
          [ -f ./docs/.vuepress/dist/index.html ] && echo "✅ index.html 存在" || echo "❌ index.html 缺失"

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/.vuepress/dist  # 添加 ./ 前缀
          enable_jekyll: false
          keep_files: false  # 每次部署前清理旧文件